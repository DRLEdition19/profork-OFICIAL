#!/bin/bash
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------

app=ps3plus
url=$(curl -s https://rpcs3.net/download | grep -oP '(?<=<a href=")[^"]*rpcs3-binaries-linux.*x64.*(?=")' | head -n 1)

# Validate URL
if [[ -z "$url" ]]; then
    echo "Error: Failed to extract the download URL for RPCS3."
    exit 1
fi

# Ensure the full URL
if [[ ! "$url" =~ ^http ]]; then
    url="https://rpcs3.net$url"
fi

#--------------------------------------------------------------------------------------------------------------------------------
#################################################################################################################################
# Optional parameters ----------------------------------------------------------------------------------------------------------------
prefix=""        # install directory, default: /userdata/system/pro/$app
name=""          # custom install info-name for app/package/system etc
ext=""           # default: extras.txt, filelist for download for get-extras
dep=""           # get app dependencies (libs)
repo=""          # specify custom repo (hosting)
mode=""          # screen / text, default=screen
theme=""         # color / bw, default=color
loader=""        # loading animation yes/no, default=yes
custom=""        # run app-custom/post/install script, default=/extras/custom.sh
port=""          # add port (name), none = /extras/port.sh (to $app.sh), or /extras/launcher.sh
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
cd /tmp
c=/tmp/batocera.pro-config
rm "$c" 2>/dev/null

{
    echo "app=$app"
    echo "url=$url"
    echo "prefix=$prefix"
    echo "name=$name"
    echo "ext=$ext"
    echo "dep=$dep"
    echo "repo=$repo"
    echo "mode=$mode"
    echo "theme=$theme"
    echo "loader=$loader"
    echo "custom=$custom"
    echo "port=$port"
} >> "$c"

#################################################################################################################################
# Start pro-framework 
cd /tmp/
rm /tmp/pro-framework.sh 2>/dev/null

wget --no-check-certificate --no-cache --no-cookies -q -O /tmp/pro-framework.sh \
https://raw.githubusercontent.com/uureel/batocera.pro/main/.dep/pro-framework.sh

dos2unix /tmp/pro-framework.sh
source /tmp/pro-framework.sh

#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
say-hi
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
mkdir -p /userdata/system/pro/ps3plus/rpcs3/ 2>/dev/null

# Download AppImage
get-appimage "$url" "/userdata/system/pro/ps3plus/rpcs3" "rpcs3.AppImage"
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to download RPCS3 AppImage."
    exit 1
fi

#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
get-extras
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
add-custom
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
# Add-port 
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
add-autostart
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
say-bye
#################################################################################################################################
#--------------------------------------------------------------------------------------------------------------------------------
